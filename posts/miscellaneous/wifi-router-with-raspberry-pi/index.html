<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Set up Raspberry Pi as a router for any equipment">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Developing With Equipment From Work During The Pandemic | RC Notebook</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="https://ravi-chandran.github.io/posts/miscellaneous/wifi-router-with-raspberry-pi/">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Ravi Chandran">
<link rel="prev" href="../../python/a-simple-command-timer-for-windows/" title="A Simple Command Timer for Windows" type="text/html">
<link rel="next" href="../../git/recommendations-for-a-git-beginner/" title="Recommendations for a git beginner" type="text/html">
<meta property="og:site_name" content="RC Notebook">
<meta property="og:title" content="Developing With Equipment From Work During The Pandemic">
<meta property="og:url" content="https://ravi-chandran.github.io/posts/miscellaneous/wifi-router-with-raspberry-pi/">
<meta property="og:description" content="Set up Raspberry Pi as a router for any equipment">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-03-21T09:34:05-04:00">
<meta property="article:tag" content="iptables">
<meta property="article:tag" content="networking">
<meta property="article:tag" content="Raspberry Pi">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="https://ravi-chandran.github.io/">
            <img src="../../../images/rcnotebooksmall.png" alt="RC Notebook" id="logo" class="d-inline-block align-top"></a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Developing With Equipment From Work During The Pandemic</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Ravi Chandran
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2020-03-21T09:34:05-04:00" itemprop="datePublished" title="2020-03-21">2020-03-21</time></a>
            </p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/miscellaneous/wifi-router-with-raspberry-pi.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p><img alt="" src="../../../images/miscellaneous/rpi_router.png"></p>
<p>With the advent of the disastrous COVID-19, I decided to write this down as a sort of COVID-19 survival tip.</p>
<p>I've had to take a work project home and set it up in my home office. The work project is an embedded system with a physical Ethernet interface for networking (i.e. no WiFi), and requires internet access. I used an old Raspberry Pi 3 that I had laying around and set it up as a router to get the embedded system onto the internet.</p>
<p>Here are the steps.</p>
<!-- TEASER_END -->

<h3>Hardware</h3>
<ul>
<li>Raspberry Pi (I used a 3 model B)</li>
<li>SD card</li>
<li>PC with SD card reader/writer</li>
<li>PC with Balena Etcher installed:</li>
<li>I used the portable version of <a href="https://www.balena.io/etcher/">Balena Etcher for Windows</a>, specifically this <a href="https://github.com/balena-io/etcher/releases/download/v1.5.79/balenaEtcher-Portable-1.5.79.exe">release</a>
</li>
</ul>
<h3>Raspberry Pi Initial Setup</h3>
<ul>
<li>
<p>Download the zip file for <a href="https://downloads.raspberrypi.org/raspbian_full_latest">Raspbian Buster with desktop</a>. At the time, the image had a release date of 2020-02-13.</p>
</li>
<li>
<p>Unzip the downloaded file to retrieve the Raspbian <code>.img</code> file.</p>
</li>
<li>
<p>Flash the SD card with the <code>.img</code> file using Balena Etcher.</p>
</li>
<li>
<p>Plug the SD card into the Pi and power up.</p>
</li>
<li>
<p>Answer the questions, allow update, connect to your home Wifi. Change the password to something secure.</p>
</li>
<li>
<p>From a shell, "<code>curl google.com</code>" and verify internet connectivity via WiFi.</p>
</li>
<li>Troubleshooting tip: The WiFi SSID and password that was configured can be found in <code>/etc/wpa_supplicant/wpa_supplicant.conf</code>.</li>
</ul>
<h3>Unit Under Test Setup</h3>
<p>As shown in the diagram above, the unit under test (UUT) has an interface <code>eth1</code> with a static IP address <code>192.168.168.167</code>. We want the UUT's traffic towards the internet to be routed via the Pi's <code>eth0</code> interface.</p>
<ul>
<li>Execute the following in the UUT to set up the Pi as the UUT's default gateway. (Making this setting permanent across reboots is beyond the scope here as it depends on the specifics of the UUT.)</li>
</ul>
<pre class="code literal-block"><span></span>route add default gw <span class="m">192</span>.168.168.1 dev eth1
</pre>


<ul>
<li>Verify the result. The routing table in the UUT should show the gateway:</li>
</ul>
<pre class="code literal-block"><span></span>$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="m">0</span>.0.0.0         <span class="m">192</span>.168.168.1   <span class="m">0</span>.0.0.0         UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> eth1
...
</pre>


<h3>Router Setup</h3>
<p>Now let's set up the Pi as a router. Note that we will <em>not</em> set up DHCP as everything is statically configured in this use case.</p>
<ul>
<li>
<p>Enable IPv4 forwarding: Edit <code>/etc/sysctl.conf</code> and uncomment the line <code>net.ipv4.ip_forward = 1</code></p>
</li>
<li>
<p>Create a script called <code>start_router.sh</code> with the following content and place it in the Pi's home directory <code>/home/pi</code>:</p>
</li>
</ul>
<pre class="code literal-block"><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">ip_address</span><span class="o">=</span><span class="s2">"192.168.168.1"</span>
<span class="nv">netmask</span><span class="o">=</span><span class="s2">"255.255.255.0"</span>
<span class="nv">eth</span><span class="o">=</span><span class="s2">"eth0"</span>
<span class="nv">wlan</span><span class="o">=</span><span class="s2">"wlan0"</span>

<span class="c1"># enable routing</span>
sudo sh -c <span class="s2">"echo 1 &gt; /proc/sys/net/ipv4/ip_forward"</span>

<span class="c1"># set the `eth0` IP address</span>
sudo ifconfig <span class="nv">$eth</span> <span class="nv">$ip_address</span> netmask <span class="nv">$netmask</span>

<span class="c1"># add a route to reach UUT and anything else on the 192.168.168.0/24 network</span>
sudo route add -net <span class="m">192</span>.168.168.0 netmask <span class="m">255</span>.255.255.0 gw <span class="m">192</span>.168.168.1 dev eth0

<span class="c1"># set up iptables to perform NAT</span>
sudo iptables -t nat -A POSTROUTING -o <span class="nv">$wlan</span> -j MASQUERADE
sudo iptables -A FORWARD -i <span class="nv">$wlan</span> -o <span class="nv">$eth</span> -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i <span class="nv">$eth</span> -o <span class="nv">$wlan</span> -j ACCEPT
</pre>


<ul>
<li>Set up the <code>/home/pi/start_router.sh</code> to be executed on boot by adding <code>/home/pi/start_router.sh</code> to the line before "<code>exit 0</code>" in <code>/etc/rc.local</code>. The resulting example file is shown below with the changes in bold.</li>
</ul>
<pre>
#!/bin/sh -e
#
# rc.local
#
# This script is executed at the end of each multiuser runlevel.
# Make sure that the script will "exit 0" on success or any other
# value on error.
#
# In order to enable or disable this script just change the execution
# bits.
#
# By default this script does nothing.

# Print the IP address
_IP=$(hostname -I) || true
if [ "$_IP" ]; then
  printf "My IP address is %s\n" "$_IP"
fi
<b>
# Set RPi as router to the internet
/home/pi/start_router.sh
</b>
exit 0
</pre>

<ul>
<li>Reboot the Pi and verify that the UUT can access the internet through the Pi with the physical connectivity set up as shown above.</li>
</ul>
<h3>SSH Access To The Pi From A PC</h3>
<ul>
<li>
<p>Enable the SSH server in the Pi using <code>sudo raspi-config</code>, <code>Interfaces</code>, and selecting <code>Enabled</code> for SSH. More details <a href="https://www.raspberrypi.org/documentation/remote-access/ssh/">here</a>.</p>
</li>
<li>
<p>Add the following to <code>~/.ssh/config</code> in your PC:</p>
</li>
</ul>
<pre class="code literal-block"><span></span>Host rpi
  User pi
  Hostname <span class="m">192</span>.168.168.1
</pre>


<ul>
<li>
<p>Copy your public key from your PC to the Pi for password-less access in future: <code>ssh-copy-id rpi</code> (you'll have to enter the password this one time)</p>
</li>
<li>
<p>Verify SSH access from the PC: <code>ssh rpi</code></p>
</li>
</ul>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/iptables/" rel="tag">iptables</a></li>
            <li><a class="tag p-category" href="../../../categories/networking/" rel="tag">networking</a></li>
            <li><a class="tag p-category" href="../../../categories/raspberry-pi/" rel="tag">Raspberry Pi</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../../python/a-simple-command-timer-for-windows/" rel="prev" title="A Simple Command Timer for Windows">Previous post</a>
            </li>
            <li class="next">
                <a href="../../git/recommendations-for-a-git-beginner/" rel="next" title="Recommendations for a git beginner">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="rcnotebook",
            disqus_url="https://ravi-chandran.github.io/posts/miscellaneous/wifi-router-with-raspberry-pi/",
        disqus_title="Developing With Equipment From Work During The Pandemic",
        disqus_identifier="cache/posts/miscellaneous/wifi-router-with-raspberry-pi.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="rcnotebook";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2020         <a href="mailto:">Ravi Chandran</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<br><a rel="license" href="https://opensource.org/licenses/MIT">MIT License for Software, </a>
<a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons License CC BY 4.0 for other items</a>

            
            
        </footer>
</div>
</div>


        <script src="../../../assets/js/all-nocdn.js"></script><script src="../../../assets/js/moment-with-locales.min.js"></script><!-- fancy dates --><script>
        moment.locale("en");
        fancydates(2, "YYYY-MM-DD HH:mm");
        </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
